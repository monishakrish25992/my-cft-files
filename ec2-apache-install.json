{
   "AWSTemplateFormatVersion":"2010-09-09",
   "Description":"Installing Apache web server on Amazon Linux EC2 with UserData",
   "Parameters":{
      "KeyPair":{
         "Description":"Name of the keypair to use for SSH access",
         "Type":"String"
      }
   },
   "Resources":{
      "WebServerSecurityGroup":{
         "Type":"AWS::EC2::SecurityGroup",
         "Properties":{
            "GroupDescription":"Enable HTTP ingress",
            "VpcId":"vpc-e6bd1682",
            "SecurityGroupIngress":[
               {
                  "IpProtocol":"tcp",
                  "FromPort":"80",
                  "ToPort":"80",
                  "CidrIp":"0.0.0.0/0"
               },
               {
                  "IpProtocol":"tcp",
                  "FromPort":"22",
                  "ToPort":"22",
                  "CidrIp":"0.0.0.0/0"
               }
            ]
         }
      },
      "WebServerInstance":{
         "Type":"AWS::EC2::Instance",
         "Properties":{
            "InstanceType":"t2.micro",
            "ImageId":"ami-e0ba5c83",
            "NetworkInterfaces":[
               {
                  "GroupSet":[
                     {
                        "Ref":"WebServerSecurityGroup"
                     }
                  ],
                  "AssociatePublicIpAddress":"true",
                  "DeviceIndex":"0",
                  "DeleteOnTermination":"true",
                  "SubnetId":"subnet-a28710fa"
               }
            ],
            "KeyName":{
               "Ref":"KeyPair"
            },
            "UserData":{
               "Fn::Base64":{
                  "Fn::Join":[
                     "\n",
                     [
                        "#!/bin/bash -xe",
                        "sudo yum update -y",
                        "sudo yum install httpd -y",
                        "sudo /etc/init.d/httpd start",
                        "echo \"<html><body><h1>Awesome !!!</h1>\" > /var/www/html/index.html",
                        "echo \"</body></html>\" >> /var/www/html/index.html"
                     ]
                  ]
               }
            }
         }
      }
   },
   "Outputs":{
      "URL":{
         "Description":"URL of the sample website",
         "Value":{
            "Fn::Join":[
               "",
               [
                  "http://",
                  {
                     "Fn::GetAtt":[
                        "WebServerInstance",
                        "PublicDnsName"
                     ]
                  }
               ]
            ]
         }
      }
   }
}
